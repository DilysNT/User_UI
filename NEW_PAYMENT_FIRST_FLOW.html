<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ New Payment-First Booking Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .flow-section { background: white; border-radius: 12px; padding: 24px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .step { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 16px; margin: 12px 0; position: relative; }
        .step.success { border-color: #10b981; background: #f0fdf4; }
        .step.danger { border-color: #ef4444; background: #fef2f2; }
        .step.warning { border-color: #f59e0b; background: #fffbeb; }
        .step-number { position: absolute; top: -10px; left: 16px; background: #3b82f6; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .step.success .step-number { background: #10b981; }
        .step.danger .step-number { background: #ef4444; }
        .step.warning .step-number { background: #f59e0b; }
        .code-block { background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; margin: 12px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .old-flow { background: #fef2f2; border: 2px solid #fecaca; }
        .new-flow { background: #f0fdf4; border: 2px solid #bbf7d0; }
        .highlight { background: #fef3c7; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .api-endpoint { background: #dbeafe; padding: 8px 12px; border-radius: 6px; font-family: monospace; margin: 8px 0; }
        .success-box { background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; padding: 16px; margin: 16px 0; }
        .error-box { background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin: 16px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Payment-First Booking Flow Implementation</h1>
        
        <div class="flow-section">
            <h2>üìã Thay ƒë·ªïi ƒë√£ implement:</h2>
            <div class="success-box">
                <h3>‚úÖ ƒê√£ ho√†n th√†nh:</h3>
                <ul>
                    <li><strong>Booking.tsx:</strong> Kh√¥ng t·∫°o booking record, ch·ªâ chu·∫©n b·ªã paymentData</li>
                    <li><strong>Payment.tsx:</strong> Nh·∫≠n paymentData, x·ª≠ l√Ω thanh to√°n v·ªõi tour ID</li>
                    <li><strong>PaymentSuccess.tsx:</strong> T·∫°o booking CH·ªà KHI thanh to√°n th√†nh c√¥ng</li>
                    <li><strong>PaymentFailed.tsx:</strong> X·ª≠ l√Ω l·ªói v√† cho ph√©p retry</li>
                    <li><strong>Flow logic:</strong> Payment-first ‚Üí Booking creation ‚Üí Confirmation</li>
                </ul>
            </div>
        </div>

        <div class="flow-section">
            <h2>üîÑ So s√°nh Old vs New Flow:</h2>
            <div class="comparison">
                <div class="old-flow step">
                    <h3>‚ùå Old Flow (Booking-first)</h3>
                    <ol>
                        <li>User ƒëi·ªÅn form booking</li>
                        <li><span class="highlight">T·∫°o booking record v·ªõi status pending</span></li>
                        <li>Chuy·ªÉn ƒë·∫øn payment v·ªõi bookingId</li>
                        <li>Thanh to√°n VNPay/MoMo</li>
                        <li>Update booking status ‚Üí confirmed</li>
                    </ol>
                    <div class="error-box">
                        <strong>‚ùå V·∫•n ƒë·ªÅ:</strong> Booking ƒë√£ t·ªìn t·∫°i k·ªÉ c·∫£ khi thanh to√°n th·∫•t b·∫°i
                    </div>
                </div>
                
                <div class="new-flow step">
                    <h3>‚úÖ New Flow (Payment-first)</h3>
                    <ol>
                        <li>User ƒëi·ªÅn form booking</li>
                        <li><span class="highlight">L∆∞u pendingBooking v√†o localStorage</span></li>
                        <li>Chuy·ªÉn ƒë·∫øn payment v·ªõi tourId</li>
                        <li>Thanh to√°n VNPay/MoMo</li>
                        <li><span class="highlight">T·∫°o booking CH·ªà KHI thanh to√°n th√†nh c√¥ng</span></li>
                    </ol>
                    <div class="success-box">
                        <strong>‚úÖ K·∫øt qu·∫£:</strong> Booking ch·ªâ t·ªìn t·∫°i khi thanh to√°n th√†nh c√¥ng
                    </div>
                </div>
            </div>
        </div>

        <div class="flow-section">
            <h2>üéØ New Flow Step by Step:</h2>
            
            <div class="step success">
                <div class="step-number">1</div>
                <h3>Booking Page (Chu·∫©n b·ªã data)</h3>
                <p><strong>File:</strong> components/details/Booking.tsx</p>
                <p><strong>Action:</strong> T√≠nh to√°n pricing, chu·∫©n b·ªã pendingBooking, KH√îNG t·∫°o booking record</p>
                <div class="api-endpoint">localStorage.setItem("paymentData", JSON.stringify(paymentData))</div>
                <div class="code-block">
// Booking.tsx - handleSubmit
const pendingBookingData = {
  tour_id: tourData.id,
  departure_date_id: tourData.departure_date_id,
  // ... other booking info
  status: 'pending', // Ch·ªù thanh to√°n
  user_id: isUserLoggedIn ? userInfo.id : null
};

const paymentData = {
  tour: { ...tourData, pricing... },
  pendingBooking: pendingBookingData,
  isUserLoggedIn,
  userInfo,
  authToken
};

// Redirect to payment TR∆Ø·ªöC KHI t·∫°o booking
router.push(`/tour/${tourData.id}/payment`);
                </div>
            </div>

            <div class="step warning">
                <div class="step-number">2</div>
                <h3>Payment Page (X·ª≠ l√Ω thanh to√°n)</h3>
                <p><strong>File:</strong> components/details/Payment.tsx</p>
                <p><strong>Action:</strong> Nh·∫≠n paymentData, t·∫°o payment v·ªõi tourId (kh√¥ng ph·∫£i bookingId)</p>
                <div class="api-endpoint">POST /api/payments/vnpay/create-payment (v·ªõi tourId)</div>
                <div class="code-block">
// Payment.tsx - handlePayment
const tourId = paymentData.tour.id; // S·ª≠ d·ª•ng tourId
const totalAmount = paymentData.tour.total_price;

// T·∫°o VNPay payment v·ªõi tour info
const response = await fetch('/api/payments/vnpay/create-payment', {
  method: 'POST',
  body: JSON.stringify({
    tourId: tourId, // KH√îNG ph·∫£i bookingId
    amount: totalAmount,
    orderInfo: `Thanh toan tour ${paymentData.tour.name}`,
    returnUrl: '/payment-success',
    cancelUrl: '/payment-failed'
  })
});

// L∆∞u pending payment ƒë·ªÉ x·ª≠ l√Ω sau
localStorage.setItem("pendingPayment", JSON.stringify(paymentData));
                </div>
            </div>

            <div class="step success">
                <div class="step-number">3a</div>
                <h3>Payment Success (T·∫°o booking)</h3>
                <p><strong>File:</strong> app/payment-success/page.tsx</p>
                <p><strong>Action:</strong> T·∫†O booking record CH·ªà KHI thanh to√°n th√†nh c√¥ng</p>
                <div class="api-endpoint">POST /api/bookings (v·ªõi status: 'confirmed')</div>
                <div class="code-block">
// PaymentSuccess.tsx
const pendingPaymentData = localStorage.getItem("pendingPayment");
const paymentData = JSON.parse(pendingPaymentData);

// L·∫•y payment result t·ª´ URL params
const paymentResult = {
  orderId: searchParams.get("vnp_TxnRef"),
  transactionId: searchParams.get("vnp_TransactionNo"),
  responseCode: searchParams.get("vnp_ResponseCode")
};

// Ki·ªÉm tra thanh to√°n th√†nh c√¥ng
if (paymentResult.responseCode === "00") {
  // T·∫†O booking v·ªõi status confirmed
  const bookingPayload = {
    ...paymentData.pendingBooking,
    status: 'confirmed', // ‚úÖ ƒê√£ x√°c nh·∫≠n
    payment_status: 'paid',
    payment_method: 'vnpay',
    payment_reference: paymentResult.orderId
  };
  
  const bookingRes = await fetch('/api/bookings', {
    method: 'POST',
    body: JSON.stringify(bookingPayload)
  });
}
                </div>
            </div>

            <div class="step danger">
                <div class="step-number">3b</div>
                <h3>Payment Failed (Kh√¥ng t·∫°o booking)</h3>
                <p><strong>File:</strong> app/payment-failed/page.tsx</p>
                <p><strong>Action:</strong> Clear pending data, cho ph√©p retry</p>
                <div class="api-endpoint">localStorage.removeItem("pendingPayment")</div>
                <div class="code-block">
// PaymentFailed.tsx
useEffect(() => {
  // Clear payment data khi thanh to√°n th·∫•t b·∫°i
  localStorage.removeItem("pendingPayment");
  
  console.log('‚ùå Payment failed - no booking created');
}, []);

const handleRetry = () => {
  // Cho ph√©p user th·ª≠ l·∫°i thanh to√°n
  const paymentData = localStorage.getItem("paymentData");
  if (paymentData) {
    const parsed = JSON.parse(paymentData);
    router.push(`/tour/${parsed.tour.id}/payment`);
  }
};
                </div>
            </div>
        </div>

        <div class="flow-section">
            <h2>üîß Technical Changes:</h2>
            
            <h3>üìÅ Files Modified:</h3>
            <div class="step">
                <h4>1. components/details/Booking.tsx</h4>
                <ul>
                    <li>‚ùå Removed: Booking creation API call</li>
                    <li>‚úÖ Added: pendingBooking data preparation</li>
                    <li>‚úÖ Added: paymentData localStorage storage</li>
                    <li>‚úÖ Changed: Redirect to /tour/{tourId}/payment</li>
                </ul>
            </div>
            
            <div class="step">
                <h4>2. components/details/Payment.tsx</h4>
                <ul>
                    <li>‚ùå Removed: bookingData state and API calls</li>
                    <li>‚úÖ Added: paymentData state from localStorage</li>
                    <li>‚úÖ Added: createBookingAfterPayment function</li>
                    <li>‚úÖ Changed: Use tourId instead of bookingId for payments</li>
                </ul>
            </div>
            
            <div class="step">
                <h4>3. app/payment-success/page.tsx</h4>
                <ul>
                    <li>‚úÖ Added: Booking creation logic after payment success</li>
                    <li>‚úÖ Added: Payment result validation</li>
                    <li>‚úÖ Added: VAT calculation for confirmed bookings</li>
                    <li>‚úÖ Added: Error handling for booking creation</li>
                </ul>
            </div>
            
            <div class="step">
                <h4>4. app/payment-failed/page.tsx</h4>
                <ul>
                    <li>‚úÖ Added: Payment data cleanup</li>
                    <li>‚úÖ Added: Retry payment functionality</li>
                    <li>‚úÖ Added: Better error messaging</li>
                </ul>
            </div>
        </div>

        <div class="flow-section">
            <h2>üéØ User Experience Outcomes:</h2>
            
            <div class="step success">
                <h3>‚úÖ Thanh to√°n th√†nh c√¥ng:</h3>
                <ol>
                    <li>User ho√†n t·∫•t thanh to√°n VNPay/MoMo</li>
                    <li>Booking record ƒë∆∞·ª£c t·∫°o v·ªõi status "confirmed"</li>
                    <li>Email x√°c nh·∫≠n ƒë∆∞·ª£c g·ª≠i t·ª± ƒë·ªông</li>
                    <li>VAT ƒë∆∞·ª£c t√≠nh to√°n (n·∫øu c√≥ agency)</li>
                    <li>Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang confirmation</li>
                </ol>
            </div>
            
            <div class="step danger">
                <h3>‚ùå Thanh to√°n th·∫•t b·∫°i:</h3>
                <ol>
                    <li>User h·ªßy thanh to√°n ho·∫∑c thanh to√°n l·ªói</li>
                    <li><strong>KH√îNG t·∫°o booking record</strong></li>
                    <li>Hi·ªÉn th·ªã th√¥ng b√°o "ƒê·∫∑t tour th·∫•t b·∫°i"</li>
                    <li>Cho ph√©p user th·ª≠ l·∫°i thanh to√°n</li>
                    <li>C√≥ th·ªÉ quay v·ªÅ ch·ªçn ph∆∞∆°ng th·ª©c kh√°c</li>
                </ol>
            </div>
        </div>

        <div class="flow-section">
            <h2>üß™ Testing Scenarios:</h2>
            
            <div class="step">
                <h3>Test Case 1: VNPay Success</h3>
                <ol>
                    <li>ƒêi·ªÅn form booking ‚Üí PaymentData saved</li>
                    <li>Ch·ªçn VNPay ‚Üí Redirect to VNPay</li>
                    <li>Thanh to√°n th√†nh c√¥ng ‚Üí Return v·ªõi vnp_ResponseCode=00</li>
                    <li>PaymentSuccess t·∫°o booking ‚Üí Confirmed status</li>
                    <li>Redirect to confirmation page</li>
                </ol>
            </div>
            
            <div class="step">
                <h3>Test Case 2: MoMo Success</h3>
                <ol>
                    <li>ƒêi·ªÅn form booking ‚Üí PaymentData saved</li>
                    <li>Ch·ªçn MoMo ‚Üí Redirect to MoMo</li>
                    <li>Thanh to√°n th√†nh c√¥ng ‚Üí Return v·ªõi resultCode=0</li>
                    <li>PaymentSuccess t·∫°o booking ‚Üí Confirmed status</li>
                    <li>Redirect to confirmation page</li>
                </ol>
            </div>
            
            <div class="step">
                <h3>Test Case 3: Payment Failed</h3>
                <ol>
                    <li>ƒêi·ªÅn form booking ‚Üí PaymentData saved</li>
                    <li>Ch·ªçn payment method ‚Üí Redirect to payment gateway</li>
                    <li>User h·ªßy ho·∫∑c thanh to√°n l·ªói</li>
                    <li>PaymentFailed page ‚Üí Clear pending data</li>
                    <li><strong>NO booking created</strong></li>
                </ol>
            </div>
        </div>

        <div class="flow-section">
            <h2>üéâ Result Summary:</h2>
            
            <div class="success-box">
                <h3>üéØ Y√™u c·∫ßu ƒë√£ ho√†n th√†nh:</h3>
                <ul>
                    <li>‚úÖ <strong>"Thanh to√°n b·∫Øt bu·ªôc tr∆∞·ªõc khi ƒë·∫∑t tour"</strong> - Booking ch·ªâ ƒë∆∞·ª£c t·∫°o SAU khi thanh to√°n th√†nh c√¥ng</li>
                    <li>‚úÖ <strong>"ƒê·∫∑t tour th·∫•t b·∫°i" khi thanh to√°n th·∫•t b·∫°i</strong> - Kh√¥ng t·∫°o booking record</li>
                    <li>‚úÖ <strong>"Booking th√†nh c√¥ng" ch·ªâ khi thanh to√°n th√†nh c√¥ng</strong> - Status confirmed v·ªõi payment_reference</li>
                    <li>‚úÖ <strong>Flow ho√†n ch·ªânh:</strong> Form ‚Üí Payment ‚Üí Success ‚Üí Booking ‚Üí Confirmation</li>
                    <li>‚úÖ <strong>Error handling:</strong> Payment failed ‚Üí No booking + Retry option</li>
                </ul>
            </div>
            
            <div class="error-box">
                <h3>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</h3>
                <ul>
                    <li>Backend c·∫ßn c·∫≠p nh·∫≠t payment APIs ƒë·ªÉ nh·∫≠n tourId thay v√¨ bookingId</li>
                    <li>Database c·∫ßn th√™m payment_reference field cho bookings table</li>
                    <li>Email service ch·ªâ g·ª≠i khi booking status = 'confirmed'</li>
                    <li>Test k·ªπ c√°c scenarios thanh to√°n success/failed</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
