<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Slots Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .calculation-box { 
            background: #e8f5e8; 
            border: 2px solid #4caf50; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
        }
        .step { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .result { background: #2196f3; color: white; padding: 15px; text-align: center; font-size: 18px; border-radius: 5px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px; width: 300px; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧮 Available Slots Calculator</h1>
        <p>Tool này sẽ tính chính xác số chỗ trống còn lại</p>
        
        <div>
            <label>Tour ID:</label><br>
            <input type="text" id="tourId" value="2231a82b-6b08-4835-8a33-b7e6e031b430" placeholder="Tour ID">
        </div>
        
        <div>
            <label>Departure Date ID:</label><br>
            <input type="text" id="departureDateId" value="979846c0-1c5d-4dc9-84fd-866eb9d7d11b" placeholder="Departure Date ID">
        </div>
        
        <button onclick="calculateAvailableSlots()">🧮 Tính Available Slots</button>
        
        <div id="result"></div>
    </div>

    <script>
        async function calculateAvailableSlots() {
            const tourId = document.getElementById('tourId').value;
            const departureDateId = document.getElementById('departureDateId').value;
            const resultDiv = document.getElementById('result');
            
            if (!tourId || !departureDateId) {
                alert('Vui lòng nhập đầy đủ Tour ID và Departure Date ID');
                return;
            }
            
            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px;">🔄 Đang tính toán...</div>';
            
            try {
                // Step 1: Get tour data
                resultDiv.innerHTML = '<div>📊 Bước 1: Lấy thông tin tour...</div>';
                const tourResponse = await fetch(`http://localhost:5000/api/tours/${tourId}/complete`);
                const tourData = await tourResponse.json();
                
                // Step 2: Get confirmed bookings
                resultDiv.innerHTML += '<div>📋 Bước 2: Lấy danh sách confirmed bookings...</div>';
                const bookingsResponse = await fetch(`http://localhost:5000/api/bookings?tour_id=${tourId}&departure_date_id=${departureDateId}&status=confirmed`);
                const bookingsData = await bookingsResponse.json();
                const confirmedBookings = Array.isArray(bookingsData) ? bookingsData : (bookingsData.bookings || []);
                
                // Step 3: Calculate
                const maxParticipants = tourData.max_participants || 0;
                let totalConfirmedGuests = 0;
                let bookingDetails = '';
                
                confirmedBookings.forEach((booking, index) => {
                    const adults = booking.number_of_adults || 0;
                    const children = booking.number_of_children || 0;
                    const guests = adults + children;
                    totalConfirmedGuests += guests;
                    
                    bookingDetails += `
<div class="step">
    ${index + 1}. Booking ID: ${booking.id.substring(0, 8)}...
    <br>👥 ${adults} người lớn + ${children} trẻ em = <strong>${guests} guests</strong>
</div>`;
                });
                
                const availableSlots = Math.max(0, maxParticipants - totalConfirmedGuests);
                
                resultDiv.innerHTML = `
<div class="calculation-box">
<h3>🧮 CÔNG THỨC TÍNH AVAILABLE SLOTS</h3>

<strong>Available Slots = Math.max(0, Max Participants - Total Confirmed Guests)</strong>

<div class="step">
📊 <strong>Tour:</strong> ${tourData.name}
<br>🎯 <strong>Max Participants:</strong> ${maxParticipants}
</div>

<div class="step">
📋 <strong>Confirmed Bookings:</strong> ${confirmedBookings.length} bookings
<br>👥 <strong>Total Confirmed Guests:</strong> ${totalConfirmedGuests}
</div>

<h4>Chi tiết từng booking:</h4>
${bookingDetails}

<div class="step">
🧮 <strong>Tính toán:</strong>
<br>Math.max(0, ${maxParticipants} - ${totalConfirmedGuests}) = Math.max(0, ${maxParticipants - totalConfirmedGuests}) = <strong>${availableSlots}</strong>
</div>

</div>

<div class="result">
🎯 KẾT QUẢ: CÒN ${availableSlots} CHỖ TRỐNG
</div>

<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
<strong>📝 GHI CHÚ:</strong>
<br>• Chỉ tính confirmed bookings (không tính pending)
<br>• Mỗi booking có thể có nhiều guests (adults + children)
<br>• Nếu total guests > max participants thì available = 0
<br>• Tour này ${availableSlots === 0 ? 'đã FULL' : 'Đã đặt/'.maxParticipants }
</div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                        ❌ Lỗi: ${error.message}
                    </div>
                `;
            }
        }
        
        // Auto calculate on page load
        window.onload = function() {
            calculateAvailableSlots();
        };
    </script>
</body>
</html>
