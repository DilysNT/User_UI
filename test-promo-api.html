<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Promo Code API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #0284c7; }
        .result { background: #f1f5f9; padding: 15px; border-radius: 6px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        .success { border-left: 4px solid #10b981; background: #f0fdf4; }
        .error { border-left: 4px solid #ef4444; background: #fef2f2; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #d1d5db; border-radius: 4px; width: 200px; }
        .promo-card { border: 2px solid #10b981; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Promo Code API</h1>
        
        <div class="section">
            <h2>üîß API Test Controls</h2>
            <div>
                <label>User ID:</label>
                <input type="text" id="userId" value="12" placeholder="12">
                
                <label>Tour ID:</label>
                <input type="text" id="tourId" value="105" placeholder="105">
                
                <label>Rating:</label>
                <select id="rating">
                    <option value="5">5 stars</option>
                    <option value="4">4 stars</option>
                    <option value="3">3 stars</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h2>üìù Test Scenarios</h2>
            
            <h3>1. Completion Promo Code</h3>
            <button onclick="testCompletionPromo()">Test t·∫°o m√£ sau ho√†n th√†nh tour</button>
            <div id="completion-result" class="result"></div>
            
            <h3>2. Fetch User Promo Codes</h3>
            <button onclick="testFetchUserPromos()">Test l·∫•y danh s√°ch m√£ c·ªßa user</button>
            <div id="fetch-result" class="result"></div>
            
            <h3>3. Use Promo Code</h3>
            <input type="text" id="promoToUse" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°">
            <button onclick="testUsePromo()">Test s·ª≠ d·ª•ng m√£</button>
            <div id="use-result" class="result"></div>
            
            <h3>4. Birthday Promo</h3>
            <button onclick="testBirthdayPromo()">Test t·∫°o m√£ sinh nh·∫≠t</button>
            <div id="birthday-result" class="result"></div>
            
            <h3>5. Loyalty Promo</h3>
            <button onclick="testLoyaltyPromo()">Test t·∫°o m√£ kh√°ch h√†ng th√¢n thi·∫øt</button>
            <div id="loyalty-result" class="result"></div>
        </div>

        <div class="section">
            <h2>üìä Generated Promo Codes</h2>
            <div id="generated-codes"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001'; // Adjust based on your backend

        // Helper function to display results
        function displayResult(elementId, data, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            element.textContent = JSON.stringify(data, null, 2);
        }

        // Helper function to add generated code to display
        function addGeneratedCode(code, type, description) {
            const codesDiv = document.getElementById('generated-codes');
            codesDiv.innerHTML += `
                <div class="promo-card">
                    <div style="font-size: 18px; font-weight: bold; letter-spacing: 2px;">${code}</div>
                    <div style="opacity: 0.9; margin-top: 5px;">${type} - ${description}</div>
                </div>
            `;
        }

        // Test 1: Completion Promo Code
        async function testCompletionPromo() {
            const userId = document.getElementById('userId').value;
            const tourId = document.getElementById('tourId').value;
            const rating = document.getElementById('rating').value;

            try {
                console.log('Testing completion promo for user:', userId);
                
                // Test our promoCodeUtils function
                const mockCompletionData = {
                    userId: parseInt(userId),
                    tourId: parseInt(tourId),
                    tourName: "Tour Du l·ªãch H·∫° Long Bay",
                    reviewRating: parseInt(rating),
                    completedAt: new Date().toISOString()
                };

                // Simulate API call
                const response = await fetch(`${API_BASE}/api/user-promocodes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'completion',
                        userId: userId,
                        data: mockCompletionData
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult('completion-result', result, true);
                    addGeneratedCode(result.promoCode, 'COMPLETION', 'M√£ c·∫£m ∆°n sau ho√†n th√†nh tour');
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }

            } catch (error) {
                console.log('API not available, using mock data:', error.message);
                
                // Mock response when API is not available
                const mockPromoCode = generateMockPromoCode('completion');
                const mockResult = {
                    success: true,
                    promoCode: mockPromoCode,
                    discountPercent: 10,
                    maxDiscount: 500000,
                    minOrderValue: 1000000,
                    expiresAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString(),
                    description: "M√£ gi·∫£m gi√° c·∫£m ∆°n sau khi ho√†n th√†nh tour",
                    source: `Tour ${tourId}`,
                    message: "Ch√∫c m·ª´ng! B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c m√£ gi·∫£m gi√° 10%"
                };
                
                displayResult('completion-result', mockResult, true);
                addGeneratedCode(mockPromoCode, 'COMPLETION', 'M√£ c·∫£m ∆°n sau ho√†n th√†nh tour');
            }
        }

        // Test 2: Fetch User Promo Codes
        async function testFetchUserPromos() {
            const userId = document.getElementById('userId').value;

            try {
                const response = await fetch(`${API_BASE}/api/user-promocodes?userId=${userId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    displayResult('fetch-result', result, true);
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }

            } catch (error) {
                console.log('API not available, using mock data:', error.message);
                
                // Mock user promo codes
                const mockPromoCodes = [
                    {
                        id: 1,
                        code: generateMockPromoCode('completion'),
                        type: 'completion',
                        discountPercent: 10,
                        maxDiscount: 500000,
                        minOrderValue: 1000000,
                        status: 'active',
                        expiresAt: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(),
                        source: 'Tour 105',
                        createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: 2,
                        code: generateMockPromoCode('loyalty'),
                        type: 'loyalty',
                        discountPercent: 20,
                        maxDiscount: 2000000,
                        minOrderValue: 3000000,
                        status: 'active',
                        expiresAt: new Date(Date.now() + 150 * 24 * 60 * 60 * 1000).toISOString(),
                        source: 'VIP Gold Member',
                        createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString()
                    },
                    {
                        id: 3,
                        code: generateMockPromoCode('birthday'),
                        type: 'birthday',
                        discountPercent: 15,
                        maxDiscount: 1000000,
                        minOrderValue: 2000000,
                        status: 'used',
                        expiresAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                        source: 'Birthday 2025',
                        usedAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString()
                    }
                ];
                
                displayResult('fetch-result', { promoCodes: mockPromoCodes }, true);
            }
        }

        // Test 3: Use Promo Code
        async function testUsePromo() {
            const promoCode = document.getElementById('promoToUse').value;
            const userId = document.getElementById('userId').value;

            if (!promoCode) {
                alert('Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/user-promocodes/${promoCode}/use`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        orderValue: 2000000 // Mock order value
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult('use-result', result, true);
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }

            } catch (error) {
                console.log('API not available, using mock validation:', error.message);
                
                // Mock validation
                const mockResult = {
                    success: true,
                    message: 'M√£ gi·∫£m gi√° ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng th√†nh c√¥ng',
                    discountAmount: 200000,
                    finalAmount: 1800000,
                    usedAt: new Date().toISOString()
                };
                
                displayResult('use-result', mockResult, true);
            }
        }

        // Test 4: Birthday Promo
        async function testBirthdayPromo() {
            const userId = document.getElementById('userId').value;

            try {
                const response = await fetch(`${API_BASE}/api/user-promocodes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'birthday',
                        userId: userId,
                        data: {
                            birthday: new Date().toISOString(),
                            age: 25
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult('birthday-result', result, true);
                    addGeneratedCode(result.promoCode, 'BIRTHDAY', 'M√£ gi·∫£m gi√° sinh nh·∫≠t');
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }

            } catch (error) {
                console.log('API not available, using mock data:', error.message);
                
                const mockPromoCode = generateMockPromoCode('birthday');
                const mockResult = {
                    success: true,
                    promoCode: mockPromoCode,
                    discountPercent: 15,
                    maxDiscount: 1000000,
                    minOrderValue: 2000000,
                    expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    description: "M√£ gi·∫£m gi√° sinh nh·∫≠t ƒë·∫∑c bi·ªát",
                    source: "Birthday 2025",
                    message: "Ch√∫c m·ª´ng sinh nh·∫≠t! üéÇ"
                };
                
                displayResult('birthday-result', mockResult, true);
                addGeneratedCode(mockPromoCode, 'BIRTHDAY', 'M√£ gi·∫£m gi√° sinh nh·∫≠t');
            }
        }

        // Test 5: Loyalty Promo
        async function testLoyaltyPromo() {
            const userId = document.getElementById('userId').value;

            try {
                const response = await fetch(`${API_BASE}/api/user-promocodes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'loyalty',
                        userId: userId,
                        data: {
                            completedTours: 7,
                            tier: 'gold'
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult('loyalty-result', result, true);
                    addGeneratedCode(result.promoCode, 'LOYALTY', 'M√£ VIP kh√°ch h√†ng th√¢n thi·∫øt');
                } else {
                    throw new Error(`API Error: ${response.status}`);
                }

            } catch (error) {
                console.log('API not available, using mock data:', error.message);
                
                const mockPromoCode = generateMockPromoCode('loyalty');
                const mockResult = {
                    success: true,
                    promoCode: mockPromoCode,
                    discountPercent: 20,
                    maxDiscount: 2000000,
                    minOrderValue: 3000000,
                    expiresAt: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString(),
                    description: "M√£ gi·∫£m gi√° VIP V√†ng - kh√°ch h√†ng th√¢n thi·∫øt",
                    source: "Gold VIP Member (7 tours)",
                    message: "Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë·∫°t c·∫•p VIP V√†ng ü•á"
                };
                
                displayResult('loyalty-result', mockResult, true);
                addGeneratedCode(mockPromoCode, 'LOYALTY', 'M√£ VIP kh√°ch h√†ng th√¢n thi·∫øt');
            }
        }

        // Helper function to generate mock promo codes
        function generateMockPromoCode(type = 'completion') {
            const prefixes = {
                completion: 'TOUR',
                birthday: 'BIRTH',
                loyalty: 'LOYAL',
                referral: 'REF'
            };
            
            const prefix = prefixes[type];
            const userSuffix = Math.floor(Math.random() * 99).toString().padStart(2, '0');
            const dateSuffix = new Date().toISOString().slice(2, 10).replace(/-/g, '');
            const random = Math.random().toString(36).substring(2, 5).toUpperCase();
            
            return `${prefix}${userSuffix}${dateSuffix}${random}`;
        }

        // Auto-fill promo code input from generated codes
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('promo-card')) {
                const code = e.target.querySelector('div').textContent.trim();
                document.getElementById('promoToUse').value = code;
            }
        });
    </script>
</body>
</html>
