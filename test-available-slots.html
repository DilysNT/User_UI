<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Available Slots Logic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .api-result {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Available Slots Logic</h1>
    
    <div class="test-section">
        <h3>📊 Test API Endpoint</h3>
        <p>Test the booking count API to see how many confirmed bookings exist for a tour + departure date.</p>
        
        <div>
            <label>Tour ID: </label>
            <input type="text" id="tourId" value="1" placeholder="Enter tour ID">
        </div>
        <div style="margin: 10px 0;">
            <label>Departure Date ID: </label>
            <input type="text" id="departureDateId" value="test-departure-1" placeholder="Enter departure date ID">
        </div>
        
        <button onclick="testBookingAPI()">🔍 Test Booking API</button>
        <button onclick="testTourAPI()">🎯 Test Tour API (Get max_participants)</button>
        
        <div id="apiResult" class="api-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>🧮 Calculate Available Slots</h3>
        <p>Based on the API results above, calculate how many slots are available.</p>
        
        <div>
            <label>Max Participants: </label>
            <input type="number" id="maxParticipants" value="20" placeholder="Tour max participants">
        </div>
        <div style="margin: 10px 0;">
            <label>Confirmed Bookings (Total Guests): </label>
            <input type="number" id="confirmedGuests" value="0" placeholder="Total confirmed guests">
        </div>
        
        <button onclick="calculateSlots()">📊 Calculate Available Slots</button>
        
        <div id="calculationResult" class="api-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>🎯 Test Tour Detail Page</h3>
        <p>Navigate to tour detail page to see the real-time available slots in action.</p>
        
        <button onclick="goToTourDetail()">🚀 Go to Tour Detail Page</button>
    </div>

    <script>
        async function testBookingAPI() {
            const tourId = document.getElementById('tourId').value;
            const departureDateId = document.getElementById('departureDateId').value;
            
            if (!tourId || !departureDateId) {
                alert('Please enter both Tour ID and Departure Date ID');
                return;
            }
            
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Loading...';
            
            try {
                const url = `http://localhost:5000/api/bookings?tour_id=${tourId}&departure_date_id=${departureDateId}&status=confirmed`;
                console.log('Testing URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                const bookings = Array.isArray(data) ? data : (data.bookings || []);
                const totalGuests = bookings.reduce((total, booking) => {
                    return total + (booking.number_of_adults || 0) + (booking.number_of_children || 0);
                }, 0);
                
                document.getElementById('confirmedGuests').value = totalGuests;
                
                resultDiv.textContent = `
API Response:
URL: ${url}
Status: ${response.status}
Bookings Count: ${bookings.length}
Total Confirmed Guests: ${totalGuests}

Detailed Bookings:
${JSON.stringify(bookings, null, 2)}
                `;
                
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        async function testTourAPI() {
            const tourId = document.getElementById('tourId').value;
            
            if (!tourId) {
                alert('Please enter Tour ID');
                return;
            }
            
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Loading tour data...';
            
            try {
                const url = `http://localhost:5000/api/tours/${tourId}/complete`;
                console.log('Testing Tour URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('maxParticipants').value = data.max_participants || 20;
                
                resultDiv.textContent = `
Tour API Response:
URL: ${url}
Status: ${response.status}
Tour Name: ${data.name}
Max Participants: ${data.max_participants}
Min Participants: ${data.min_participants}

Full Tour Data:
${JSON.stringify(data, null, 2)}
                `;
                
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }
        
        function calculateSlots() {
            const maxParticipants = parseInt(document.getElementById('maxParticipants').value) || 0;
            const confirmedGuests = parseInt(document.getElementById('confirmedGuests').value) || 0;
            
            const availableSlots = Math.max(0, maxParticipants - confirmedGuests);
            
            const resultDiv = document.getElementById('calculationResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = `
Calculation Result:
Max Participants: ${maxParticipants}
Confirmed Guests: ${confirmedGuests}
Available Slots: ${availableSlots}

Status: ${availableSlots > 0 ? '✅ Slots available' : '❌ Fully booked'}
            `;
        }
        
        function goToTourDetail() {
            const tourId = document.getElementById('tourId').value || '1';
            window.location.href = `http://localhost:3001/tour/${tourId}`;
        }
    </script>
</body>
</html>
