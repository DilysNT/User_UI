<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear localStorage - Test Payment Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .action { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        .success { background: #28a745; }
        .success:hover { background: #218838; }
        .info { background: #17a2b8; }
        .info:hover { background: #138496; }
    </style>
</head>
<body>
    <h1>üßπ Clear localStorage & Test Payment Flow</h1>
    
    <div class="action">
        <h3>üìä Current localStorage Status</h3>
        <div id="storageStatus">Loading...</div>
        <button onclick="checkStorage()">üîÑ Refresh Status</button>
    </div>

    <div class="action">
        <h3>üßπ Clear Data Actions</h3>
        <button class="danger" onclick="clearPaymentData()">Clear Payment Data Only</button>
        <button class="danger" onclick="clearBookingData()">Clear Booking Data Only</button>
        <button class="danger" onclick="clearAllData()">Clear All localStorage</button>
    </div>

    <div class="action">
        <h3>üß™ Test Data Setup</h3>
        <button class="success" onclick="setupTestTour()">Setup Test Tour Data</button>
        <button class="success" onclick="setupTestPayment()">Setup Test Payment Data</button>
    </div>

    <div class="action">
        <h3>üöÄ Navigation Actions</h3>
        <button class="info" onclick="goToBooking()">Go to Booking Page</button>
        <button class="info" onclick="goToPayment()">Go to Payment Page</button>
        <button class="info" onclick="testVNPayCallback()">Test VNPay Success Callback</button>
    </div>

    <script>
        function checkStorage() {
            const keys = Object.keys(localStorage);
            const relevantKeys = keys.filter(key => 
                key.includes('payment') || 
                key.includes('booking') || 
                key.includes('tour') ||
                key.includes('auth')
            );
            
            const status = document.getElementById('storageStatus');
            status.innerHTML = `
                <strong>Total Keys:</strong> ${keys.length}<br>
                <strong>Relevant Keys:</strong> ${relevantKeys.length}<br>
                <div style="margin-top: 10px;">
                    ${relevantKeys.map(key => {
                        const value = localStorage.getItem(key);
                        const preview = value ? (value.length > 100 ? value.substring(0, 100) + '...' : value) : 'null';
                        return `<div style="margin: 5px 0; padding: 5px; background: #e9ecef; border-radius: 3px;">
                            <strong>${key}:</strong> ${preview}
                        </div>`;
                    }).join('')}
                </div>
            `;
        }

        function clearPaymentData() {
            localStorage.removeItem('paymentData');
            localStorage.removeItem('pendingPayment'); 
            localStorage.removeItem('pendingBookingData');
            alert('‚úÖ Payment data cleared');
            checkStorage();
        }

        function clearBookingData() {
            localStorage.removeItem('bookingData');
            localStorage.removeItem('bookingFormData');
            localStorage.removeItem('bookingPromoData');
            alert('‚úÖ Booking data cleared');
            checkStorage();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will clear ALL localStorage data. Continue?')) {
                localStorage.clear();
                alert('‚úÖ All localStorage cleared');
                checkStorage();
            }
        }

        function setupTestTour() {
            const testTour = {
                id: 1,
                name: "Tour du l·ªãch ƒê√† L·∫°t 4N3ƒê - Test",
                price: 2610000,
                departure_date_id: 'test-departure-1',
                departure_date_value: '2025-07-25',
                adults: 1,
                children: 0,
                location: 'ƒê√† L·∫°t',
                departure_location: 'TP.HCM',
                tour_categories: 'Du l·ªãch sinh th√°i',
                duration: '4N3ƒê',
                image: '/placeholder.svg',
                agency_id: null,
                referral_code: null,
                booking_prepared: true,
                booking_timestamp: Date.now()
            };
            
            localStorage.setItem('selectedTour', JSON.stringify(testTour));
            alert('‚úÖ Test tour data setup complete');
            checkStorage();
        }

        function setupTestPayment() {
            const testTour = JSON.parse(localStorage.getItem('selectedTour') || '{}');
            
            if (!testTour.id) {
                alert('‚ùå Please setup test tour first!');
                return;
            }

            const testPaymentData = {
                tour: testTour,
                pendingBooking: {
                    tour_id: testTour.id,
                    departure_date_id: testTour.departure_date_id,
                    number_of_adults: testTour.adults || 1,
                    number_of_children: testTour.children || 0,
                    number_of_guests: (testTour.adults || 1) + (testTour.children || 0),
                    guests: [{
                        name: "Test User",
                        email: "test@example.com",
                        phone: "0123456789",
                        cccd: "123456789012"
                    }],
                    special_requests: null,
                    status: 'pending',
                    original_price: testTour.price * (testTour.adults || 1),
                    total_price: testTour.price * (testTour.adults || 1),
                    discount_amount: 0,
                    promotion_id: null,
                    user_id: null,
                    user_type: 'GUEST_USER'
                },
                authToken: null,
                isUserLoggedIn: false,
                userInfo: null
            };

            localStorage.setItem('paymentData', JSON.stringify(testPaymentData));
            localStorage.setItem('pendingPayment', JSON.stringify(testPaymentData));
            localStorage.setItem('pendingBookingData', JSON.stringify(testPaymentData.pendingBooking));
            
            alert('‚úÖ Test payment data setup complete');
            checkStorage();
        }

        function goToBooking() {
            const testTour = JSON.parse(localStorage.getItem('selectedTour') || '{}');
            if (testTour.id) {
                window.location.href = `http://localhost:3001/tour/${testTour.id}/booking`;
            } else {
                alert('‚ùå No tour selected. Setup test tour first.');
            }
        }

        function goToPayment() {
            const testTour = JSON.parse(localStorage.getItem('selectedTour') || '{}');
            if (testTour.id) {
                window.location.href = `http://localhost:3001/tour/${testTour.id}/payment`;
            } else {
                alert('‚ùå No tour selected. Setup test tour first.');
            }
        }

        function testVNPayCallback() {
            // Simulate VNPay success callback
            const params = new URLSearchParams({
                vnp_Amount: '261000000', // 2,610,000 VND * 100
                vnp_BankCode: 'NCB',
                vnp_BankTranNo: 'VNP15089112',
                vnp_CardType: 'ATM',
                vnp_OrderInfo: 'Thanh+toan+tour+Test',
                vnp_PayDate: '20250721143022',
                vnp_ResponseCode: '00', // Success
                vnp_TmnCode: 'TEST123',
                vnp_TransactionNo: 'VNP123456789',
                vnp_TransactionStatus: '00',
                vnp_TxnRef: 'ORDER123456'
            });
            
            window.location.href = `http://localhost:3001/payment-success?${params.toString()}`;
        }

        // Auto-check storage on load
        checkStorage();
    </script>
</body>
</html>
