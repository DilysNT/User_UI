<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Promo Cards</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .promo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin: 20px 0; }
        .promo-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; transition: all 0.3s; }
        .promo-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .promo-header { padding: 16px; color: white; text-align: center; }
        .promo-header.blue { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .promo-header.orange { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .promo-header.green { background: linear-gradient(135deg, #10b981, #14b8a6); }
        .promo-header.pink { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .discount-amount { font-size: 32px; font-weight: bold; margin-bottom: 4px; }
        .off-text { font-size: 12px; opacity: 0.9; }
        .promo-content { padding: 16px; }
        .promo-code { font-family: monospace; font-size: 18px; font-weight: bold; text-align: center; background: #f3f4f6; padding: 8px 12px; border-radius: 8px; border: 2px dashed #d1d5db; margin-bottom: 12px; }
        .promo-description { font-size: 14px; color: #6b7280; text-align: center; margin-bottom: 16px; line-height: 1.4; }
        .time-left { display: flex; align-items: center; justify-content: center; gap: 4px; font-size: 12px; color: #f59e0b; margin-bottom: 16px; }
        .promo-buttons { display: flex; flex-direction: column; gap: 8px; }
        .btn-copy { width: 100%; padding: 8px 12px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .btn-copy:hover { background: #e5e7eb; }
        .btn-use { width: 100%; padding: 8px 12px; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-use.blue { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .btn-use.orange { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .btn-use.green { background: linear-gradient(135deg, #10b981, #14b8a6); }
        .btn-use.pink { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .btn-use:hover { opacity: 0.9; }
        .api-info { background: #eff6ff; border: 1px solid #3b82f6; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .demo-screen { background: #1f2937; color: white; padding: 15px; border-radius: 8px; font-family: monospace; margin: 10px 0; }
        button { padding: 10px 15px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .success { background: #f0fdf4; color: #166534; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .error { background: #fef2f2; color: #dc2626; padding: 10px; border-radius: 6px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé´ Test API Promo Cards - Card Style</h1>
        
        <div class="section">
            <h2>üì° API Integration Test</h2>
            <div class="api-info">
                <strong>API Endpoint:</strong> <code>http://localhost:5000/api/promotions</code><br>
                <strong>Expected Format:</strong> Array of promo objects with id, code, description, discount_amount, start_date, end_date
            </div>
            
            <button onclick="fetchAndDisplayPromos()">üîÑ Fetch Real API Data</button>
            <button onclick="showMockData()">üé≠ Show Mock Data</button>
            <button onclick="clearDisplay()">üóëÔ∏è Clear Display</button>
            
            <div id="api-status" class="demo-screen">Click "Fetch Real API Data" to test API connection...</div>
        </div>

        <div class="section">
            <h2>üé® Promo Cards Display</h2>
            <div id="promo-cards-container" class="promo-grid">
                <!-- Promo cards will be inserted here -->
            </div>
        </div>

        <div class="section">
            <h2>üìä Test Results</h2>
            <div id="test-results" class="demo-screen">Test results will appear here...</div>
        </div>
    </div>

    <script>
        let copiedCode = null;

        // Mock data that matches API format
        const mockApiData = [
            {
                "id": "6ebd5e55-47b6-48de-b0ae-b33d5a6f5d9e",
                "code": "JULY2507",
                "description": "Gi·∫£m gi√° cu·ªëi th√°ng cho c√°c du kh√°ch v·ª´a h·∫øt ti·ªÅn l∆∞∆°ng",
                "discount_amount": "500000.00",
                "start_date": "2025-07-19T00:00:00.000Z",
                "end_date": "2025-08-01T00:00:00.000Z",
                "created_at": "2025-07-19T10:19:44.000Z",
                "updated_at": "2025-07-19T10:31:14.000Z"
            },
            {
                "id": "promo-summer-2025",
                "code": "SUMMER2025",
                "description": "Gi·∫£m gi√° 10% cho t·∫•t c·∫£ c√°c tour kh·ªüi h√†nh trong th√°ng 7 v√† 8.",
                "discount_amount": "10.00",
                "start_date": "2025-07-01T00:00:00.000Z",
                "end_date": "2025-08-31T00:00:00.000Z",
                "created_at": "2025-06-15T09:00:00.000Z",
                "updated_at": "2025-07-19T11:46:18.000Z"
            },
            {
                "id": "flash-weekend-deal",
                "code": "FLASH25",
                "description": "Flash sale cu·ªëi tu·∫ßn - Gi·∫£m ngay 25% cho c√°c tour du l·ªãch trong n∆∞·ªõc",
                "discount_amount": "25.00",
                "start_date": "2025-07-20T00:00:00.000Z",
                "end_date": "2025-07-28T00:00:00.000Z",
                "created_at": "2025-07-20T08:00:00.000Z",
                "updated_at": "2025-07-20T08:00:00.000Z"
            },
            {
                "id": "family-special",
                "code": "FAMILY15",
                "description": "∆Øu ƒë√£i ƒë·∫∑c bi·ªát cho gia ƒë√¨nh - Gi·∫£m gi√° khi ƒë·∫∑t tour t·ª´ 4 ng∆∞·ªùi tr·ªü l√™n",
                "discount_amount": "15.00",
                "start_date": "2025-07-15T00:00:00.000Z",
                "end_date": "2025-09-15T00:00:00.000Z",
                "created_at": "2025-07-15T10:00:00.000Z",
                "updated_at": "2025-07-15T10:00:00.000Z"
            }
        ];

        async function fetchAndDisplayPromos() {
            updateStatus('üì° Fetching data from API...');
            updateTestResults('üîÑ Starting API fetch test...\n');
            
            try {
                const response = await fetch('http://localhost:5000/api/promotions');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateStatus('‚úÖ API fetch successful!');
                updateTestResults(`‚úÖ API Response received: ${data.length} promo codes\n`);
                
                displayPromoCards(data);
                
            } catch (error) {
                updateStatus(`‚ùå API Error: ${error.message}`);
                updateTestResults(`‚ùå API Error: ${error.message}\n`);
                updateTestResults(`üé≠ Falling back to mock data...\n`);
                
                // Show mock data as fallback
                displayPromoCards(mockApiData);
            }
        }

        function showMockData() {
            updateStatus('üé≠ Displaying mock data...');
            updateTestResults('üé≠ Using mock data for testing...\n');
            displayPromoCards(mockApiData);
        }

        function displayPromoCards(apiData) {
            const container = document.getElementById('promo-cards-container');
            
            // Transform API data to component format
            const transformedData = apiData.map(promo => {
                const discountAmount = parseFloat(promo.discount_amount);
                const isPercentage = discountAmount <= 100;
                
                return {
                    id: promo.id,
                    code: promo.code,
                    description: promo.description,
                    discountAmount: discountAmount,
                    isPercentage: isPercentage,
                    expiresAt: promo.end_date,
                    isActive: new Date(promo.end_date) > new Date()
                };
            });

            // Filter only active promos
            const activePromos = transformedData.filter(promo => promo.isActive);
            
            updateTestResults(`üìä Data transformation complete:\n`);
            updateTestResults(`   - Total promos: ${transformedData.length}\n`);
            updateTestResults(`   - Active promos: ${activePromos.length}\n`);

            if (activePromos.length === 0) {
                container.innerHTML = '<div class="error">‚ùå No active promo codes found</div>';
                return;
            }

            // Generate promo cards HTML
            const cardsHTML = activePromos.map((promo, index) => {
                const colors = ['blue', 'orange', 'green', 'pink'];
                const colorClass = colors[index % colors.length];
                
                const timeLeft = getTimeLeft(promo.expiresAt);
                const discountDisplay = formatDiscount(promo.discountAmount, promo.isPercentage);
                
                return `
                    <div class="promo-card">
                        <div class="promo-header ${colorClass}">
                            <div class="discount-amount">${discountDisplay}</div>
                            <div class="off-text">OFF</div>
                        </div>
                        <div class="promo-content">
                            <div class="promo-code">${promo.code}</div>
                            <div class="promo-description">${promo.description}</div>
                            <div class="time-left">
                                ‚è∞ ${timeLeft}
                            </div>
                            <div class="promo-buttons">
                                <button class="btn-copy" onclick="copyPromoCode('${promo.code}')">
                                    ${copiedCode === promo.code ? '‚úÖ ƒê√£ sao ch√©p!' : 'üìã Sao ch√©p'}
                                </button>
                                <button class="btn-use ${colorClass}" onclick="usePromoCode('${promo.code}')">
                                    üöÄ S·ª≠ d·ª•ng ngay
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cardsHTML;
            updateTestResults(`‚úÖ Displayed ${activePromos.length} promo cards\n`);
        }

        function formatDiscount(amount, isPercentage) {
            if (isPercentage) {
                return `${amount}%`;
            } else {
                return `${amount.toLocaleString('vi-VN')}‚Ç´`;
            }
        }

        function getTimeLeft(expiresAt) {
            const now = new Date().getTime();
            const expiry = new Date(expiresAt).getTime();
            const difference = expiry - now;

            if (difference <= 0) return "ƒê√£ h·∫øt h·∫°n";

            const days = Math.floor(difference / (1000 * 60 * 60 * 24));
            const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (days > 0) return `C√≤n ${days} ng√†y`;
            if (hours > 0) return `C√≤n ${hours} gi·ªù`;
            return "S·∫Øp h·∫øt h·∫°n";
        }

        function copyPromoCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                copiedCode = code;
                localStorage.setItem('copiedPromoCode', code);
                updateTestResults(`üìã Copied "${code}" to clipboard and localStorage\n`);
                
                // Update the button text
                const buttons = document.querySelectorAll('.btn-copy');
                buttons.forEach(btn => {
                    if (btn.textContent.includes('ƒê√£ sao ch√©p!')) {
                        btn.textContent = 'üìã Sao ch√©p';
                    }
                });
                
                // Update the clicked button
                event.target.textContent = '‚úÖ ƒê√£ sao ch√©p!';
                
                setTimeout(() => {
                    copiedCode = null;
                    event.target.textContent = 'üìã Sao ch√©p';
                }, 2000);
                
            }).catch(err => {
                updateTestResults(`‚ùå Failed to copy: ${err}\n`);
            });
        }

        function usePromoCode(code) {
            copyPromoCode(code);
            localStorage.setItem('copiedPromoCode', code);
            updateTestResults(`üöÄ Using "${code}" - would redirect to /search\n`);
            
            setTimeout(() => {
                alert('Trong ·ª©ng d·ª•ng th·ª±c t·∫ø, b·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang /search ƒë·ªÉ t√¨m tour!');
            }, 500);
        }

        function clearDisplay() {
            document.getElementById('promo-cards-container').innerHTML = '';
            updateStatus('üóëÔ∏è Display cleared');
            updateTestResults('üóëÔ∏è Cleared promo cards display\n');
        }

        function updateStatus(message) {
            document.getElementById('api-status').textContent = message;
        }

        function updateTestResults(message) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.textContent += message;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTestResults('üöÄ API Promo Cards Test Environment Ready\n');
            updateTestResults('üí° Click "Fetch Real API Data" to test with live data\n');
            updateTestResults('üé≠ Or click "Show Mock Data" to test with sample data\n\n');
        });
    </script>
</body>
</html>
